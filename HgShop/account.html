<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T√†i kho·∫£n - HgShop</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="auth.js"></script>
  <script defer src="script.js"></script>
  <script defer src="chatbot.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <a href="index.html" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <img id="siteLogoImg" src="images/logo.png" alt="HgShop" class="site-logo" onerror="this.style.display='none'"/>
        <div class="logo-text-wrap">
          <div class="logo-text">
  <span class="logo-h">H</span><span class="logo-g">g</span><span class="logo-shop">Shop</span>
</div>
        </div>
      </a>
    </div>
    <a href="index.html" class="link white">‚Üê Trang ch·ªß</a>
  </header>

  <main class="container narrow">
    <h2>T√†i kho·∫£n c·ªßa t√¥i</h2>

    <section id="profile" class="card">
      <img id="profileAvatar" src="images/default-avatar.png" class="avatar-large" alt="avatar"/>
      <input type="file" id="avatarInput" accept="image/*" />
      <div style="margin-top:8px">
        <button id="downloadAvatar" class="secondary">T·∫£i avatar v·ªÅ (ƒë·ªÉ upload v√†o images/uploads/)</button>
      </div>
      <p id="userInfo" style="margin-top:12px"></p>
      <div style="margin-top:12px">
        <h4>ƒê·ªïi th√¥ng tin</h4>
        <input id="edit_name" placeholder="H·ªç t√™n" />
        <input id="edit_phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
        <input id="edit_password" type="password" placeholder="ƒê·ªïi m·∫≠t kh·∫©u (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="saveProfile" class="primary">L∆∞u</button>
          <button id="cancelProfile" class="secondary">H·ªßy</button>
        </div>
      </div>
    </section>

    <section id="ordersSection" class="card" style="margin-top:14px">
      <h3 id="ordersTitle">ƒê∆°n h√†ng c·ªßa t√¥i</h3>
      <div id="myOrders"></div>
    </section>
  </main>

  <footer class="footer">
    <div>¬© 2025 HgShop</div>
  </footer>

  <!-- Chatbot Widget -->
  <div id="chatbotWidget" class="chatbot-widget">
    <div id="chatbotToggle" class="chatbot-toggle">üí¨</div>
    <div id="chatbotWindow" class="chatbot-window hidden">
      <div class="chatbot-header">
        <h4>H·ªó tr·ª£ kh√°ch h√†ng</h4>
        <button id="closeChatbot" class="icon-btn">‚úñ</button>
      </div>
      <div id="chatbotMessages" class="chatbot-messages">
        <div class="message bot">
          <div class="message-content">Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n? H√£y h·ªèi t√¥i v·ªÅ s·∫£n ph·∫©m laptop, m√†n h√¨nh ho·∫∑c linh ki·ªán m√°y t√≠nh.</div>
        </div>
      </div>
      <div class="chatbot-input">
        <input id="chatbotInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." />
        <button id="sendChatbotMsg">G·ª≠i</button>
      </div>
    </div>
  </div>

  <script>
    // H√†m hi·ªÉn th·ªã form ƒë√°nh gi√°
    function showReviewForm(orderId) {
      const order = JSON.parse(localStorage.getItem('orders')||'[]').find(o=>o.id===orderId);
      if(!order) return;
      
      let reviewHTML = '<h3>ƒê√°nh gi√° ƒë∆°n h√†ng</h3>';
      order.items.forEach(item => {
        const product = window.PRODUCTS ? window.PRODUCTS.find(p=>p.id===item.id) : null;
        reviewHTML += `
          <div style="margin-bottom:16px;padding:12px;border:1px solid #e5e7eb;border-radius:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <img src="images/sanpham/${item.image}" alt="${item.name}" style="width:40px;height:40px;object-fit:cover;border-radius:4px" onerror="this.src='images/default-product.png'">
              <div><strong>${item.name}</strong></div>
            </div>
            <div>
              <div>ƒê√°nh gi√°: 
                <span class="star-rating" data-product="${item.id}">
                  ${[1,2,3,4,5].map(i=>`<span style="cursor:pointer;font-size:20px;color:#ccc" data-rating="${i}">‚òÖ</span>`).join('')}
                </span>
              </div>
              <textarea id="comment-${item.id}" placeholder="Nh·∫≠n x√©t v·ªÅ s·∫£n ph·∫©m..." style="width:100%;margin-top:8px;padding:8px;border-radius:4px;border:1px solid #e5e7eb"></textarea>
            </div>
          </div>
        `;
      });
      
      reviewHTML += `<button class="btn primary" onclick="submitReview('${orderId}')" style="margin-top:16px">G·ª≠i ƒë√°nh gi√°</button>`;
      
      // T·∫°o modal cho ƒë√°nh gi√°
      const modal = document.createElement('div');
      modal.style.cssText = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.5); display:flex; justify-content:center; 
        align-items:center; z-index:1000;
      `;
      modal.innerHTML = `
        <div style="background:white; padding:24px; border-radius:12px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">ƒê√°nh gi√° ƒë∆°n h√†ng</h3>
            <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:none;border:none;font-size:20px;cursor:pointer">‚úñ</button>
          </div>
          ${reviewHTML}
        </div>
      `;
      document.body.appendChild(modal);
      
      // X·ª≠ l√Ω rating stars
      document.querySelectorAll('.star-rating span').forEach(star => {
        star.addEventListener('mouseover', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          const container = this.parentElement;
          container.querySelectorAll('span').forEach((s, i) => {
            s.style.color = i < rating ? '#ffa500' : '#ccc';
          });
        });
        
        star.addEventListener('click', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          const productId = this.parentElement.getAttribute('data-product');
          this.parentElement.setAttribute('data-selected-rating', rating);
        });
      });
    }

    // H√†m g·ª≠i ƒë√°nh gi√°
    function submitReview(orderId) {
      const order = JSON.parse(localStorage.getItem('orders')||'[]').find(o=>o.id===orderId);
      const cur = JSON.parse(localStorage.getItem('currentUser')||'null');
      
      order.items.forEach(item => {
        const ratingEl = document.querySelector(`.star-rating[data-product="${item.id}"]`);
        const rating = ratingEl ? ratingEl.getAttribute('data-selected-rating') : null;
        const comment = document.getElementById(`comment-${item.id}`) ? document.getElementById(`comment-${item.id}`).value : '';
        
        if (rating) {
          // C·∫≠p nh·∫≠t ƒë√°nh gi√° v√†o s·∫£n ph·∫©m
          if (window.PRODUCTS) {
            const product = window.PRODUCTS.find(p=>p.id===item.id);
            if (product) {
              if (!product.reviews) product.reviews = [];
              product.reviews.push({
                user: cur.name,
                rating: parseInt(rating),
                comment: comment,
                date: new Date().toISOString().split('T')[0]
              });
              
              // C·∫≠p nh·∫≠t rating trung b√¨nh
              const totalRating = product.reviews.reduce((sum, r) => sum + r.rating, 0);
              product.rating = totalRating / product.reviews.length;
            }
          }
        }
      });
      
      // ƒê√≥ng modal
      const modal = document.querySelector('div[style*="position:fixed"]');
      if (modal) modal.remove();
      
      alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
      // Reload ƒë·ªÉ hi·ªÉn th·ªã ƒë√°nh gi√° m·ªõi
      location.reload();
    }

    // H√†m hi·ªÉn th·ªã form y√™u c·∫ßu ho√†n h√†ng
    function showReturnForm(orderId) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.5); display:flex; justify-content:center; 
        align-items:center; z-index:1000;
      `;
      modal.innerHTML = `
        <div style="background:white; padding:24px; border-radius:12px; max-width:400px; width:90%">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">Y√™u c·∫ßu ho√†n h√†ng</h3>
            <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:none;border:none;font-size:20px;cursor:pointer">‚úñ</button>
          </div>
          <textarea id="returnReason" placeholder="L√Ω do ho√†n h√†ng..." style="width:100%;height:120px;padding:12px;border-radius:8px;border:1px solid #e5e7eb"></textarea>
          <button class="btn primary" onclick="submitReturnRequest('${orderId}')" style="margin-top:16px;width:100%">G·ª≠i y√™u c·∫ßu</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // H√†m g·ª≠i y√™u c·∫ßu ho√†n h√†ng
    function submitReturnRequest(orderId) {
      const reason = document.getElementById('returnReason').value;
      if (!reason.trim()) {
        alert('Vui l√≤ng nh·∫≠p l√Ω do ho√†n h√†ng');
        return;
      }
      
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const orderIndex = orders.findIndex(o=>o.id===orderId);
      
      if (orderIndex !== -1) {
        orders[orderIndex].returnRequest = {
          reason: reason,
          status: 'Ch·ªù x·ª≠ l√Ω',
          requestedAt: new Date().toISOString()
        };
        
        localStorage.setItem('orders', JSON.stringify(orders));
        
        // Th√¥ng b√°o cho admin
        const notes = JSON.parse(localStorage.getItem('notifications')||'{}');
        const adminEmail = 'hoangne1404@gmail.com';
        notes[adminEmail] = notes[adminEmail]||[];
        notes[adminEmail].push(`ƒê∆°n ${orderId} y√™u c·∫ßu ho√†n h√†ng: ${reason}`);
        localStorage.setItem('notifications', JSON.stringify(notes));
        
        const modal = document.querySelector('div[style*="position:fixed"]');
        if (modal) modal.remove();
        
        alert('ƒê√£ g·ª≠i y√™u c·∫ßu ho√†n h√†ng!');
        location.reload();
      }
    }

    // H√†m hi·ªÉn th·ªã tr·∫°ng th√°i ho√†n h√†ng
    function showReturnStatus(orderId) {
      const order = JSON.parse(localStorage.getItem('orders')||'[]').find(o=>o.id===orderId);
      if (!order || !order.returnRequest) return;
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.5); display:flex; justify-content:center; 
        align-items:center; z-index:1000;
      `;
      modal.innerHTML = `
        <div style="background:white; padding:24px; border-radius:12px; max-width:400px; width:90%">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">Tr·∫°ng th√°i ho√†n h√†ng</h3>
            <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:none;border:none;font-size:20px;cursor:pointer">‚úñ</button>
          </div>
          <div>
            <p><strong>L√Ω do:</strong> ${order.returnRequest.reason}</p>
            <p><strong>Tr·∫°ng th√°i:</strong> ${order.returnRequest.status}</p>
            <p><strong>Ng√†y y√™u c·∫ßu:</strong> ${new Date(order.returnRequest.requestedAt).toLocaleString('vi-VN')}</p>
            ${order.returnRequest.processedAt ? `<p><strong>Ng√†y x·ª≠ l√Ω:</strong> ${new Date(order.returnRequest.processedAt).toLocaleString('vi-VN')}</p>` : ''}
            ${order.returnRequest.adminNote ? `<p><strong>Ghi ch√∫ t·ª´ admin:</strong> ${order.returnRequest.adminNote}</p>` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
  </script>
</body>
</html>