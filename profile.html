<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√†i kho·∫£n c·ªßa t√¥i - HgShop</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        // Import Firebase config
        import "./firebase-config.js";

        // Initialize Firebase
        const app = initializeApp(window.firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase objects globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;

        // Authentication state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Load user data
                const userRef = ref(database, 'users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        // Save user data to localStorage
                        localStorage.setItem('currentUser', JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            ...userData
                        }));
                    }
                });
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
            }
        });
    </script>
    
    <script defer src="auth.js"></script>
    <script defer src="script.js"></script>
    <script defer src="cart.js"></script>
    <script defer src="account.js"></script>
    <script defer src="cloudinary-config.js"></script>
    <script defer src="cloudinary.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="navbar">
        <div class="logo">
            <a href="index.html" style="color: white; text-decoration: none;">HgShop</a>
        </div>
        
        <nav class="nav-links">
            <a href="index.html">Trang ch·ªß</a>
            <a href="products.html">S·∫£n ph·∫©m</a>
            <a href="contact.html">Li√™n h·ªá</a>
            <a href="#" class="cart">Gi·ªè h√†ng üõí</a>
        </nav>
        
        <div class="topbar-icons">
            <button id="notifyBtn" class="icon-btn">
                <span class="material-icons">notifications</span>
                <span id="notificationBadge" class="badge">0</span>
            </button>
            
            <button id="cartBtn" class="icon-btn">
                <span class="material-icons cart-icon">shopping_cart</span>
                <span id="cartCount" class="badge">0</span>
            </button>
            
            <div class="avatar-wrapper">
                <img id="avatarIcon" src="images/default-avatar.png" alt="Avatar" class="avatar-icon">
            </div>
        </div>
    </header>

    <!-- Notification Tooltip -->
    <div id="notifyTooltip" class="tooltip hidden">
        <div class="tooltip-header">
            <h3>Th√¥ng b√°o</h3>
            <button id="closeNotify" class="close-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="notificationList" class="notification-list">
            <p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
        </div>
    </div>
    
    <!-- Account Menu -->
    <div id="accountMenu" class="account-menu hidden">
        <a href="profile.html" class="menu-item active">
            <span class="material-icons">person</span>
            T√†i kho·∫£n c·ªßa t√¥i
        </a>
        <a href="orders.html" class="menu-item">
            <span class="material-icons">receipt</span>
            ƒê∆°n h√†ng c·ªßa b·∫°n
        </a>
        <a id="becomeSellerLink" href="become-seller.html" class="menu-item">
            <span class="material-icons">store</span>
            <span id="sellerMenuText">Tr·ªü th√†nh ng∆∞·ªùi b√°n</span>
        </a>
        <hr>
        <button id="logoutBtn" class="menu-item logout">
            <span class="material-icons">logout</span>
            <span>ƒêƒÉng xu·∫•t</span>
        </button>
    </div>
    
    <main>
        <section class="profile-page">
            <div class="container">
                <h1>T√†i kho·∫£n c·ªßa t√¥i</h1>
                
                <div class="profile-content">
                    <div class="profile-sidebar">
                        <div class="profile-card">
                            <div class="profile-avatar">
                                <img id="profileAvatar" src="images/default-avatar.png" alt="Avatar">
                                <button id="changeAvatarBtn" class="btn secondary">ƒê·ªïi ·∫£nh</button>
                                <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                            </div>
                            <div class="profile-info">
                                <h3 id="profileName">Ng∆∞·ªùi d√πng</h3>
                                <p id="profileEmail">user@example.com</p>
                            </div>
                        </div>
                        
                        <nav class="profile-nav">
                            <a href="#profile-info" class="nav-item active">Th√¥ng tin t√†i kho·∫£n</a>
                            <a href="#address" class="nav-item">ƒê·ªãa ch·ªâ</a>
                            <a href="#security" class="nav-item">B·∫£o m·∫≠t</a>
                            <a href="orders.html" class="nav-item">ƒê∆°n h√†ng c·ªßa t√¥i</a>
                        </nav>
                    </div>
                    
                    <div class="profile-main">
                        <div id="profile-info" class="profile-section active">
                            <h2>Th√¥ng tin t√†i kho·∫£n</h2>
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="fullName">H·ªç v√† t√™n</label>
                                    <input type="text" id="fullName" name="fullName">
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" name="email" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="tel" id="phone" name="phone">
                                </div>
                                
                                <div class="form-group">
                                    <label for="birthDate">Ng√†y sinh</label>
                                    <input type="date" id="birthDate" name="birthDate">
                                </div>
                                
                                <button type="submit" class="btn primary">L∆∞u thay ƒë·ªïi</button>
                            </form>
                        </div>
                        
                        <div id="address" class="profile-section">
                            <h2>ƒê·ªãa ch·ªâ</h2>
                            <form id="addressForm">
                                <div class="form-group">
                                    <label for="street">ƒê·ªãa ch·ªâ</label>
                                    <input type="text" id="street" name="street">
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="city">Th√†nh ph·ªë</label>
                                        <input type="text" id="city" name="city">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="zipCode">M√£ b∆∞u ch√≠nh</label>
                                        <input type="text" id="zipCode" name="zipCode">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn primary">L∆∞u ƒë·ªãa ch·ªâ</button>
                            </form>
                        </div>
                        
                        <div id="security" class="profile-section">
                            <h2>B·∫£o m·∫≠t</h2>
                            <form id="securityForm">
                                <div class="form-group">
                                    <label for="currentPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                    <input type="password" id="currentPassword" name="currentPassword">
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" id="newPassword" name="newPassword">
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword">
                                </div>
                                
                                <button type="submit" class="btn primary">ƒê·ªïi m·∫≠t kh·∫©u</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Cart Sidebar -->
    <div id="cartSidebar" class="cart-sidebar hidden">
        <div class="cart-header">
            <h3>Gi·ªè h√†ng</h3>
            <button id="closeCart" class="close-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="cartItems" class="cart-items">
            <!-- Cart items will be populated here -->
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>T·ªïng c·ªông:</span>
                <span id="cartTotal">0ƒë</span>
            </div>
            <button id="checkoutBtn" class="btn primary">Thanh to√°n</button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay hidden"></div>

    <!-- About / Footer -->
    <section class="about-section" id="contact">
        <div class="container narrow">
            <h2>Gi·ªõi thi·ªáu v·ªÅ HgShop</h2>
            <p>HgShop l√† n·ªÅn t·∫£ng mua s·∫Øm linh ki·ªán m√°y t√≠nh, laptop v√† ph·ª• ki·ªán c√¥ng ngh·ªá ch·∫•t l∆∞·ª£ng.</p>
            
            <div class="about-content">
                <div class="about-info">
                    <p><strong>Mua b√°n linh ki·ªán m√°y t√≠nh, laptop uy t√≠n ch·∫•t l∆∞·ª£ng</strong></p>
                    <ul>
                        <li>üè† ƒê·ªãa ch·ªâ: 18 Louis VI, Ho√†ng Mai, Ho√†ng VƒÉn Th·ª•, H√† N·ªôi</li>
                        <li>üìû S·ªë ƒëi·ªán tho·∫°i: 0343867095</li>
                        <li>üë§ Th√†nh vi√™n: Nguy·ªÖn Nh·∫≠t Ho√†ng<br>üìß Gmail: nguyennhathoangne@gmail.com</li>
                    </ul>
                </div>
                
                <div class="about-links">
                    <div class="footer-section">
                        <h4>Li√™n k·∫øt</h4>
                        <ul>
                            <li><a href="index.html">Trang ch·ªß</a></li>
                            <li><a href="terms.html">ƒêi·ªÅu kho·∫£n</a></li>
                            <li><a href="privacy.html">B·∫£o m·∫≠t</a></li>
                            <li><a href="contact.html">Li√™n h·ªá</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Theo d√µi ch√∫ng t√¥i</h4>
                        <div class="social-links">
                            <a href="https://www.facebook.com/hvoaanng" target="_blank" class="social-link">
                                <span class="material-icons">facebook</span>
                            </a>
                            <a href="https://www.instagram.com/hgne1404" target="_blank" class="social-link">
                                <span class="material-icons">photo_camera</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>¬© 2025 HgShop. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
            </div>
        </div>
    </section>
    
    <script>
        // Profile page initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profile page loaded');
            
            // Load user data
            loadProfileData();
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // Load profile data from localStorage
        function loadProfileData() {
            const cur = JSON.parse(localStorage.getItem('currentUser') || 'null');
            console.log('Current user data:', cur);
            
            if (!cur) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update profile avatar
            const profileAvatar = document.getElementById('profileAvatar');
            const avatarIcon = document.getElementById('avatarIcon');
            if (profileAvatar && cur.avatarData) {
                profileAvatar.src = cur.avatarData;
                console.log('Profile avatar updated:', cur.avatarData);
            }
            if (avatarIcon && cur.avatarData) {
                avatarIcon.src = cur.avatarData;
                console.log('Header avatar updated:', cur.avatarData);
            }
            
            // Update profile info
            document.getElementById('profileName').textContent = cur.name || 'Ng∆∞·ªùi d√πng';
            document.getElementById('profileEmail').textContent = cur.email || '';
            
            // Fill form fields
            document.getElementById('fullName').value = cur.name || '';
            document.getElementById('email').value = cur.email || '';
            document.getElementById('phone').value = cur.phone || '';
            document.getElementById('birthDate').value = cur.birthDate || '';
        }
        
        // Set up event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners');
            
            // Change avatar button
            const changeAvatarBtn = document.getElementById('changeAvatarBtn');
            const avatarInput = document.getElementById('avatarInput');
            
            if (changeAvatarBtn && avatarInput) {
                console.log('Avatar elements found');
                
                changeAvatarBtn.addEventListener('click', function() {
                    console.log('Change avatar button clicked');
                    avatarInput.click();
                });
                
                avatarInput.addEventListener('change', function(e) {
                    console.log('Avatar input changed', e.target.files);
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        console.log('Selected file:', file);
                        
                        // Check if file is an image
                        if (!file.type.startsWith('image/')) {
                            alert('Vui l√≤ng ch·ªçn m·ªôt file ·∫£nh!');
                            return;
                        }
                        
                        // Use the updateAvatar function from auth.js
                        if (window.updateAvatar) {
                            console.log('Calling updateAvatar function');
                            window.updateAvatar(file);
                        } else {
                            console.error('updateAvatar function not available');
                            alert('Ch·ª©c nƒÉng ƒë·ªïi ·∫£nh ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
                        }
                    }
                });
            } else {
                console.log('Avatar elements not found');
            }
            
            // Profile form submission
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userData = {
                        name: document.getElementById('fullName').value,
                        phone: document.getElementById('phone').value,
                        birthDate: document.getElementById('birthDate').value
                    };
                    
                    console.log('Updating profile with data:', userData);
                    
                    // Use the updateProfile function from auth.js
                    if (window.updateProfile) {
                        window.updateProfile(userData);
                    } else {
                        console.error('updateProfile function not available');
                    }
                });
            }
            
            // Security form submission
            const securityForm = document.getElementById('securityForm');
            if (securityForm) {
                securityForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    console.log('Password change requested:', {currentPassword, newPassword, confirmPassword});
                    
                    if (newPassword !== confirmPassword) {
                        alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        alert('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                        return;
                    }
                    
                    // Use the updatePassword function from auth.js
                    if (window.updateUserPassword) {
                        console.log('Calling updateUserPassword function');
                        window.updateUserPassword(currentPassword, newPassword);
                    } else {
                        console.error('updateUserPassword function not available');
                        alert('Ch·ª©c nƒÉng ƒë·ªïi m·∫≠t kh·∫©u ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    }
                });
            }
        }
    </script>
</body>
</html>