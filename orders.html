<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i - HgShop</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        // Import Firebase config
        import "./firebase-config.js";

        // Initialize Firebase
        const app = initializeApp(window.firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase objects globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;

        // Authentication state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Load user data
                const userRef = ref(database, 'users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        // Save user data to localStorage
                        localStorage.setItem('currentUser', JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            ...userData
                        }));
                    }
                });
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
            }
        });
    </script>
    
    <script defer src="auth.js"></script>
    <script defer src="script.js"></script>
    <script defer src="cart.js"></script>
    <script defer src="account.js"></script>
    <script defer src="cloudinary-config.js"></script>
    <script defer src="cloudinary.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="navbar">
        <div class="logo">
            <a href="index.html" style="color: white; text-decoration: none;">HgShop</a>
        </div>
        
        <nav class="nav-links">
            <a href="index.html">Trang ch·ªß</a>
            <a href="products.html">S·∫£n ph·∫©m</a>
            <a href="contact.html">Li√™n h·ªá</a>
        </nav>
        
        <div class="topbar-icons">
            <button id="notifyBtn" class="icon-btn">
                <span class="material-icons">notifications</span>
                <span id="notificationBadge" class="badge">0</span>
            </button>
            
            <button id="cartBtn" class="icon-btn">
                <span class="material-icons cart-icon">shopping_cart</span>
                <span id="cartCount" class="badge">0</span>
            </button>
            
            <div class="avatar-wrapper">
                <img id="avatarIcon" src="images/default-avatar.png" alt="Avatar" class="avatar-icon">
            </div>
        </div>
    </header>

    <!-- Notification Tooltip -->
    <div id="notifyTooltip" class="tooltip hidden">
        <div class="tooltip-header">
            <h3>Th√¥ng b√°o</h3>
            <button id="closeNotify" class="close-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="notificationList" class="notification-list">
            <p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
        </div>
    </div>
    
    <!-- Account Menu -->
    <div id="accountMenu" class="account-menu hidden">
        <a href="profile.html" class="menu-item">
            <span class="material-icons">person</span>
            T√†i kho·∫£n c·ªßa t√¥i
        </a>
        <a href="orders.html" class="menu-item active">
            <span class="material-icons">receipt</span>
            ƒê∆°n h√†ng c·ªßa b·∫°n
        </a>
        <a id="becomeSellerLink" href="become-seller.html" class="menu-item">
            <span class="material-icons">store</span>
            <span id="sellerMenuText">Tr·ªü th√†nh ng∆∞·ªùi b√°n</span>
        </a>
        <hr>
        <button id="logoutBtn" class="menu-item logout">
            <span class="material-icons">logout</span>
            <span>ƒêƒÉng xu·∫•t</span>
        </button>
    </div>
    
    <main>
        <section class="orders-page">
            <div class="container">
                <h1>ƒê∆°n h√†ng c·ªßa t√¥i</h1>
                
                <div class="orders-content">
                    <div class="orders-filter">
                        <label for="orderStatusFilter">L·ªçc theo tr·∫°ng th√°i:</label>
                        <select id="orderStatusFilter">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="shipping">ƒêang giao</option>
                            <option value="delivered">ƒê√£ giao</option>
                            <option value="completed">Ho√†n th√†nh</option>
                            <option value="cancelled">ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                    
                    <div id="ordersList" class="orders-list">
                        <!-- Orders will be populated here -->
                    </div>
                </div>
            </div>
        </section>
        
        <script>
        // Orders page functionality
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Orders page loaded');
            
            // Check if user is logged in
            const cur = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!cur) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load orders
            await loadOrders(cur.uid);
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // Load orders from Firebase
        async function loadOrders(userId) {
            console.log('Loading orders for user:', userId);
            
            const ordersList = document.getElementById('ordersList');
            if (!ordersList) return;
            
            try {
                // Show loading state
                ordersList.innerHTML = '<div class="loading">ƒêang t·∫£i ƒë∆°n h√†ng...</div>';
                
                // Check if Firebase is available
                if (window.firebaseDatabase) {
                    console.log('Fetching orders from Firebase');
                    
                    // Import Firebase database functions
                    const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js");
                    
                    // Create query for user's orders
                    const ordersRef = ref(window.firebaseDatabase, 'orders');
                    const userOrdersQuery = query(ordersRef, orderByChild('userId'), equalTo(userId));
                    
                    // Listen for real-time updates
                    onValue(userOrdersQuery, (snapshot) => {
                        console.log('Received orders data from Firebase');
                        
                        if (snapshot.exists()) {
                            const ordersData = snapshot.val();
                            const orders = Object.keys(ordersData).map(key => ({
                                id: key,
                                ...ordersData[key]
                            }));
                            
                            console.log('Orders received:', orders);
                            renderOrders(orders);
                        } else {
                            console.log('No orders found for user');
                            renderOrders([]);
                        }
                    }, (error) => {
                        console.error('Error fetching orders from Firebase:', error);
                        // Fallback to localStorage
                        loadOrdersFromLocalStorage(userId);
                    });
                } else {
                    console.log('Firebase not available, falling back to localStorage');
                    loadOrdersFromLocalStorage(userId);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                ordersList.innerHTML = '<div class="error">C√≥ l·ªói x·∫£y ra khi t·∫£i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
            }
        }
        
        // Fallback function to load orders from localStorage
        function loadOrdersFromLocalStorage(userId) {
            console.log('Loading orders from localStorage for user:', userId);
            
            const ordersList = document.getElementById('ordersList');
            if (!ordersList) return;
            
            try {
                let orders = JSON.parse(localStorage.getItem('orders') || '[]');
                console.log('Orders from localStorage:', orders);
                
                // Filter orders for current user
                orders = orders.filter(order => order.userId === userId);
                console.log('Filtered orders for user:', orders);
                
                renderOrders(orders);
            } catch (error) {
                console.error('Error loading orders from localStorage:', error);
                ordersList.innerHTML = '<div class="error">C√≥ l·ªói x·∫£y ra khi t·∫£i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
            }
        }
        
        // Render orders to the page
        function renderOrders(orders) {
            console.log('Rendering orders:', orders);
            
            const ordersList = document.getElementById('ordersList');
            if (!ordersList) return;
            
            if (!orders || orders.length === 0) {
                ordersList.innerHTML = '<div class="empty-orders">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</div>';
                return;
            }
            
            // Sort orders by timestamp (newest first)
            orders.sort((a, b) => {
                const timestampA = a.timestamp ? new Date(a.timestamp) : new Date(a.createdAt || 0);
                const timestampB = b.timestamp ? new Date(b.timestamp) : new Date(b.createdAt || 0);
                return timestampB - timestampA;
            });
            
            // Apply status filter
            const statusFilter = document.getElementById('orderStatusFilter');
            const filterValue = statusFilter ? statusFilter.value : 'all';
            
            let filteredOrders = orders;
            if (filterValue !== 'all') {
                filteredOrders = orders.filter(order => order.status === filterValue);
            }
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '<div class="empty-orders">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</div>';
                return;
            }
            
            // Render orders
            ordersList.innerHTML = filteredOrders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">
                            <strong>ƒê∆°n h√†ng #${order.id}</strong>
                            <span class="order-date">${formatOrderDate(order.timestamp || order.createdAt)}</span>
                        </div>
                        <span class="order-status ${order.status}">${getOrderStatusText(order.status)}</span>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <img src="${getImageSource(item.image)}" alt="${item.name}" onerror="this.src='images/default-product.png'">
                                <div class="order-item-details">
                                    <div class="order-item-name">${item.name}</div>
                                    <div class="order-item-quantity">S·ªë l∆∞·ª£ng: ${item.qty}</div>
                                    <div class="order-item-price">${formatCurrency(item.price)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-footer">
                        <div class="order-total">
                            <strong>T·ªïng ti·ªÅn:</strong> ${formatCurrency(order.total)}
                        </div>
                        <div class="order-actions">
                            ${renderOrderActions(order)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Format order date
        function formatOrderDate(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
            } catch (error) {
                console.error('Error formatting date:', error);
                return '';
            }
        }
        
        // Get order status text
        function getOrderStatusText(status) {
            const statusMap = {
                'pending': 'Ch·ªù x√°c nh·∫≠n',
                'confirmed': 'ƒê√£ x√°c nh·∫≠n',
                'shipping': 'ƒêang giao',
                'delivered': 'ƒê√£ giao',
                'completed': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy',
                'return_requested': 'Y√™u c·∫ßu ho√†n',
                'return_processed': 'ƒê√£ ho√†n'
            };
            return statusMap[status] || status;
        }
        
        // Render order actions based on status
        function renderOrderActions(order) {
            let actions = '';
            
            if (order.status === 'delivered') {
                actions += `<button class="btn secondary" onclick="requestReturn('${order.id}')">Y√™u c·∫ßu ho√†n</button>`;
            }
            
            if (order.status === 'completed') {
                // No actions for completed orders
            }
            
            if (order.status === 'return_requested') {
                actions += `<button class="btn secondary" onclick="viewReturnStatus('${order.id}')">Xem tr·∫°ng th√°i ho√†n</button>`;
            }
            
            return actions;
        }
        
        // Get image source with proper path handling
        function getImageSource(imagePath) {
            if (!imagePath) return 'images/default-product.png';
            
            // If it's already a full URL, return as is
            if (imagePath.startsWith('http')) {
                return imagePath;
            }
            
            // If it's a Cloudinary URL or already has the correct path
            if (imagePath.includes('cloudinary.com') || imagePath.includes('sanpham/')) {
                return imagePath;
            }
            
            // Otherwise, assume it's in the sanpham folder
            return 'images/sanpham/' + imagePath;
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            const statusFilter = document.getElementById('orderStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const cur = JSON.parse(localStorage.getItem('currentUser') || 'null');
                    if (cur) {
                        loadOrders(cur.uid);
                    }
                });
            }
        }
        
        // Request return for an order
        async function requestReturn(orderId) {
            console.log('Requesting return for order:', orderId);
            alert('Ch·ª©c nƒÉng y√™u c·∫ßu ho√†n h√†ng s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai trong phi√™n b·∫£n ti·∫øp theo.');
        }
        
        // View return status
        async function viewReturnStatus(orderId) {
            console.log('Viewing return status for order:', orderId);
            alert('Tr·∫°ng th√°i ho√†n h√†ng s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y.');
        }
        </script>
    </main>

    <!-- Cart Sidebar -->
    <div id="cartSidebar" class="cart-sidebar hidden">
        <div class="cart-header">
            <h3>Gi·ªè h√†ng</h3>
            <button id="closeCart" class="close-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="cartItems" class="cart-items">
            <!-- Cart items will be populated here -->
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>T·ªïng c·ªông:</span>
                <span id="cartTotal">0ƒë</span>
            </div>
            <button id="checkoutBtn" class="btn primary">Thanh to√°n</button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay hidden"></div>

    <!-- About / Footer -->
    <section class="about-section" id="contact">
        <div class="container narrow">
            <h2>Gi·ªõi thi·ªáu v·ªÅ HgShop</h2>
            <p>HgShop l√† n·ªÅn t·∫£ng mua s·∫Øm linh ki·ªán m√°y t√≠nh, laptop v√† ph·ª• ki·ªán c√¥ng ngh·ªá ch·∫•t l∆∞·ª£ng.</p>
            
            <div class="about-content">
                <div class="about-info">
                    <p><strong>Mua b√°n linh ki·ªán m√°y t√≠nh, laptop uy t√≠n ch·∫•t l∆∞·ª£ng</strong></p>
                    <ul>
                        <li>üè† ƒê·ªãa ch·ªâ: 18 Louis VI, Ho√†ng Mai, Ho√†ng VƒÉn Th·ª•, H√† N·ªôi</li>
                        <li>üìû S·ªë ƒëi·ªán tho·∫°i: 0343867095</li>
                        <li>üë§ Th√†nh vi√™n: Nguy·ªÖn Nh·∫≠t Ho√†ng<br>üìß Gmail: nguyennhathoangne@gmail.com</li>
                    </ul>
                </div>
                
                <div class="about-links">
                    <div class="footer-section">
                        <h4>Li√™n k·∫øt</h4>
                        <ul>
                            <li><a href="index.html">Trang ch·ªß</a></li>
                            <li><a href="terms.html">ƒêi·ªÅu kho·∫£n</a></li>
                            <li><a href="privacy.html">B·∫£o m·∫≠t</a></li>
                            <li><a href="contact.html">Li√™n h·ªá</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Theo d√µi ch√∫ng t√¥i</h4>
                        <div class="social-links">
                            <a href="https://www.facebook.com/hvoaanng" target="_blank" class="social-link">
                                <span class="material-icons">facebook</span>
                            </a>
                            <a href="https://www.instagram.com/hgne1404" target="_blank" class="social-link">
                                <span class="material-icons">photo_camera</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>¬© 2025 HgShop. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
            </div>
        </div>
    </section>
</body>
</html>